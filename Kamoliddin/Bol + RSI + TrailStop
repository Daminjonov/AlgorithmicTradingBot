import time
import MetaTrader5 as mt5
import numpy as np

# Initialize and log in to MetaTrader5
if not mt5.initialize():
    print("Failed to initialize MT5")
    quit()

account = 75166105  # Replace with your account number
password = "Komoliddin001!"
server = "XMTrading-MT5 3"  # Replace with your broker's server

if not mt5.login(account, password, server):
    print(f"Login failed: {mt5.last_error()}")
    mt5.shutdown()
    quit()
else:
    print(f"Logged in to account {account}")

# Function to get the current price from MetaTrader5
def get_current_price(symbol):
    tick = mt5.symbol_info_tick(symbol)
    if tick is None:
        print(f"Symbol {symbol} not found")
        return None, None
    return tick.bid, tick.ask

# Function to calculate Bollinger Bands
def calculate_bollinger_bands(prices, window, num_std_dev):
    if len(prices) < window:
        return None, None
    sma = np.mean(prices)
    std_dev = np.std(prices)
    upper_band = sma + num_std_dev * std_dev
    lower_band = sma - num_std_dev * std_dev
    return upper_band, lower_band

# Function to calculate RSI
def calculate_rsi(prices, window=14):
    if len(prices) < window:
        return None
    deltas = np.diff(prices)
    seed = deltas[:window]
    up = seed[seed >= 0].sum() / window
    down = -seed[seed < 0].sum() / window
    rs = up / down
    rsi = 100.0 - (100.0 / (1.0 + rs))
    return rsi

# Function to submit a trade order in MetaTrader5
def submit_order(symbol, volume, is_buy, trailing_stop=False):
    price = mt5.symbol_info_tick(symbol).ask if is_buy else mt5.symbol_info_tick(symbol).bid
    order_type = mt5.ORDER_TYPE_BUY if is_buy else mt5.ORDER_TYPE_SELL

    stop_loss_diff = 0.200
    take_profit_diff = 0.200
    sl = price - stop_loss_diff if is_buy else price + stop_loss_diff
    tp = price + take_profit_diff if is_buy else price - take_profit_diff

    request = {
        "action": mt5.TRADE_ACTION_DEAL,
        "symbol": symbol,
        "volume": volume,
        "type": order_type,
        "price": price,
        "sl": sl,
        "tp": tp,
        "deviation": 10,
        "magic": 234000,
        "comment": "Enhanced Bollinger Bands trade",
        "type_time": mt5.ORDER_TIME_GTC,
        "type_filling": mt5.ORDER_FILLING_IOC,
    }

    result = mt5.order_send(request)
    if result.retcode != mt5.TRADE_RETCODE_DONE:
        print(f"Order failed: {result.comment}")
    else:
        action = "Buying" if is_buy else "Selling"
        print(f"{action} {volume} units of {symbol} at price {price}. Stop Loss: {sl}, Take Profit: {tp}")

        # If trailing stop is enabled, adjust stop loss dynamically
        if trailing_stop:
            trailing_sl(symbol, price, sl, is_buy)

# Function to dynamically adjust the stop loss to trail price
def trailing_sl(symbol, current_price, initial_sl, is_buy, trail_amount=0.05):
    while True:
        new_price = mt5.symbol_info_tick(symbol).ask if is_buy else mt5.symbol_info_tick(symbol).bid
        if is_buy and new_price > current_price + trail_amount:
            current_sl = new_price - trail_amount
            print(f"New trailing stop loss: {current_sl}")
            # Update stop loss in MT5
        elif not is_buy and new_price < current_price - trail_amount:
            current_sl = new_price + trail_amount
            print(f"New trailing stop loss: {current_sl}")
        time.sleep(10)

# Enhanced Bollinger Bands Trading Bot
def trade_bollinger_live(symbol, window, num_std_dev, volume):
    prices = []
    positions = []
    balance = 0

    while True:
        bid_price, ask_price = get_current_price(symbol)
        if bid_price is None or ask_price is None:
            time.sleep(10)
            continue
        current_price = (bid_price + ask_price) / 2
        prices.append(current_price)

        if len(prices) > window:
            prices.pop(0)
            upper_band, lower_band = calculate_bollinger_bands(prices, window, num_std_dev)
            rsi = calculate_rsi(prices, window=14)

            if upper_band is None or lower_band is None or rsi is None:
                print("Not enough data to calculate indicators")
                continue

            print(f"Current price: {current_price}, Upper band: {upper_band}, Lower band: {lower_band}, RSI: {rsi}")

            # Buy logic with RSI confirmation
            if current_price < lower_band and rsi < 30 and not positions:
                submit_order(symbol, volume, is_buy=True, trailing_stop=True)
                positions.append(current_price)
                print(f"Opening Buy order at price {current_price}")

            # Sell logic with RSI confirmation
            elif current_price > upper_band and rsi > 70 and positions:
                buy_price = positions.pop(0)
                submit_order(symbol, volume, is_buy=False, trailing_stop=True)
                profit = (current_price - buy_price) * volume
                balance += profit
                print(f"Order Closed Take Profit at price {current_price}. Profit: {profit:.2f}, Balance: {balance:.2f}")

        time.sleep(5)

# Example usage
symbol = "USDJPY"
trade_bollinger_live(symbol, window=20, num_std_dev=2, volume=0.05)

# Shutdown MetaTrader5
mt5.shutdown()
